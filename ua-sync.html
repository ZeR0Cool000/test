<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User-Agent & Client Hints Sync Tester</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #58a6ff;
      border-bottom: 1px solid #30363d;
      padding-bottom: 10px;
    }
    h2 {
      color: #8b949e;
      font-size: 14px;
      margin-top: 30px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .panel {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
    }
    .panel h3 {
      margin: 0 0 15px 0;
      color: #58a6ff;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel h3 .icon {
      font-size: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #21262d;
    }
    th {
      color: #8b949e;
      font-weight: 500;
      background: #0d1117;
    }
    td {
      font-family: 'Monaco', 'Menlo', monospace;
      word-break: break-all;
    }
    .value {
      color: #7ee787;
    }
    .missing {
      color: #f85149;
      font-style: italic;
    }

    /* Comparison section */
    .comparison {
      margin-top: 30px;
    }
    .comparison-table {
      width: 100%;
    }
    .comparison-table th {
      width: 20%;
    }
    .comparison-table .match {
      background: rgba(46, 160, 67, 0.15);
    }
    .comparison-table .mismatch {
      background: rgba(248, 81, 73, 0.15);
    }
    .comparison-table .warning {
      background: rgba(210, 153, 34, 0.15);
    }

    .status-icon {
      font-size: 16px;
      margin-right: 5px;
    }
    .status-match { color: #3fb950; }
    .status-mismatch { color: #f85149; }
    .status-warning { color: #d29922; }
    .status-info { color: #58a6ff; }

    /* Summary */
    .summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    .summary-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    .summary-card.success { border-color: #3fb950; }
    .summary-card.error { border-color: #f85149; }
    .summary-card.warning { border-color: #d29922; }
    .summary-card .number {
      font-size: 32px;
      font-weight: bold;
    }
    .summary-card .label {
      font-size: 12px;
      color: #8b949e;
      margin-top: 5px;
    }

    /* Buttons */
    .actions {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #2ea043;
    }
    button.secondary {
      background: #21262d;
      border: 1px solid #30363d;
    }
    button.secondary:hover {
      background: #30363d;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Detection alerts */
    .alerts {
      margin: 20px 0;
    }
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .alert-error {
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid #f85149;
    }
    .alert-warning {
      background: rgba(210, 153, 34, 0.1);
      border: 1px solid #d29922;
    }
    .alert-success {
      background: rgba(46, 160, 67, 0.1);
      border: 1px solid #3fb950;
    }
    .alert-icon {
      font-size: 18px;
      flex-shrink: 0;
    }
    .alert-content {
      flex: 1;
    }
    .alert-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .alert-desc {
      font-size: 12px;
      color: #8b949e;
    }

    /* Raw data */
    .raw-data {
      margin-top: 30px;
    }
    pre {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      overflow-x: auto;
      font-size: 11px;
      max-height: 300px;
      overflow-y: auto;
    }

    .copy-btn {
      float: right;
      padding: 5px 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
<h1>üîç User-Agent & Client Hints Synchronization Tester</h1>
<p style="color: #8b949e;">
  Compares HTTP headers with JavaScript APIs to detect emulation inconsistencies.
  HTTP headers are fetched via external service, JS data is collected locally.
</p>

<div class="actions">
  <button onclick="runTest()">
    <span>üöÄ</span> Run Full Test
  </button>
  <button class="secondary" onclick="copyResults()">
    <span>üìã</span> Copy Results JSON
  </button>
  <button class="secondary" onclick="location.reload()">
    <span>üîÑ</span> Refresh
  </button>
</div>

<div id="loading" class="loading" style="display: none;">
  <div class="spinner"></div>
  <p>Fetching HTTP headers and collecting JS data...</p>
</div>

<div id="results" style="display: none;">
  <!-- Summary Cards -->
  <div class="summary" id="summary"></div>

  <!-- Detection Alerts -->
  <div class="alerts" id="alerts"></div>

  <!-- Comparison Table -->
  <h2>üìä Detailed Comparison</h2>
  <div class="panel">
    <table class="comparison-table" id="comparison-table">
      <thead>
      <tr>
        <th>Parameter</th>
        <th>HTTP Header</th>
        <th>JavaScript API</th>
        <th>Status</th>
      </tr>
      </thead>
      <tbody id="comparison-body"></tbody>
    </table>
  </div>

  <!-- Side by side data -->
  <div class="container">
    <div class="panel">
      <h3><span class="icon">üåê</span> HTTP Headers (Server-side)</h3>
      <table id="http-table">
        <thead>
        <tr><th>Header</th><th>Value</th></tr>
        </thead>
        <tbody id="http-body"></tbody>
      </table>
    </div>

    <div class="panel">
      <h3><span class="icon">‚ö°</span> JavaScript APIs (Client-side)</h3>
      <table id="js-table">
        <thead>
        <tr><th>API</th><th>Value</th></tr>
        </thead>
        <tbody id="js-body"></tbody>
      </table>
    </div>
  </div>

  <!-- High Entropy Values -->
  <h2>üîê High Entropy Client Hints</h2>
  <div class="panel">
    <p style="color: #8b949e; font-size: 12px; margin-bottom: 15px;">
      These values are obtained via navigator.userAgentData.getHighEntropyValues()
    </p>
    <table id="high-entropy-table">
      <thead>
      <tr><th>Property</th><th>Value</th></tr>
      </thead>
      <tbody id="high-entropy-body"></tbody>
    </table>
  </div>

  <!-- Raw JSON -->
  <h2>üìÑ Raw Data</h2>
  <div class="raw-data">
    <button class="copy-btn secondary" onclick="copyResults()">Copy JSON</button>
    <pre id="raw-json"></pre>
  </div>
</div>

<script>
  // Global results storage
  let testResults = {
    timestamp: null,
    httpHeaders: {},
    jsData: {},
    highEntropy: {},
    comparison: [],
    alerts: [],
    score: { matches: 0, mismatches: 0, warnings: 0 }
  };

  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  const COMPARISON_MAP = [
    {
      name: 'User-Agent',
      httpHeader: 'user-agent',
      jsApi: 'navigator.userAgent',
      getJs: () => navigator.userAgent,
      compare: (http, js) => http === js
    },
    {
      name: 'Platform',
      httpHeader: 'sec-ch-ua-platform',
      jsApi: 'userAgentData.platform',
      getJs: () => navigator.userAgentData?.platform,
      compare: (http, js) => {
        if (!http || !js) return null;
        // HTTP: "Android", JS: Android (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫)
        const httpClean = http.replace(/"/g, '');
        return httpClean === js;
      }
    },
    {
      name: 'Mobile',
      httpHeader: 'sec-ch-ua-mobile',
      jsApi: 'userAgentData.mobile',
      getJs: () => navigator.userAgentData?.mobile,
      compare: (http, js) => {
        if (http === undefined || js === undefined) return null;
        // HTTP: ?1 or ?0, JS: true/false
        const httpBool = http === '?1';
        return httpBool === js;
      }
    },
    {
      name: 'Brands',
      httpHeader: 'sec-ch-ua',
      jsApi: 'userAgentData.brands',
      getJs: () => {
        const brands = navigator.userAgentData?.brands;
        if (!brands) return null;
        return brands.map(b => `"${b.brand}";v="${b.version}"`).join(', ');
      },
      compare: (http, js) => {
        if (!http || !js) return null;
        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
        const httpNorm = http.replace(/\s/g, '');
        const jsNorm = js.replace(/\s/g, '');
        return httpNorm === jsNorm;
      }
    },
    {
      name: 'Architecture',
      httpHeader: 'sec-ch-ua-arch',
      jsApi: 'highEntropy.architecture',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        const data = await navigator.userAgentData.getHighEntropyValues(['architecture']);
        return data.architecture;
      },
      compare: (http, js) => {
        if (http === undefined) return null;
        const httpClean = http.replace(/"/g, '');
        return httpClean === (js || '');
      },
      async: true
    },
    {
      name: 'Bitness',
      httpHeader: 'sec-ch-ua-bitness',
      jsApi: 'highEntropy.bitness',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        const data = await navigator.userAgentData.getHighEntropyValues(['bitness']);
        return data.bitness;
      },
      compare: (http, js) => {
        if (http === undefined) return null;
        const httpClean = http.replace(/"/g, '');
        return httpClean === (js || '');
      },
      async: true
    },
    {
      name: 'Model',
      httpHeader: 'sec-ch-ua-model',
      jsApi: 'highEntropy.model',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        const data = await navigator.userAgentData.getHighEntropyValues(['model']);
        return data.model;
      },
      compare: (http, js) => {
        if (http === undefined) return null;
        const httpClean = http.replace(/"/g, '');
        return httpClean === (js || '');
      },
      async: true
    },
    {
      name: 'Platform Version',
      httpHeader: 'sec-ch-ua-platform-version',
      jsApi: 'highEntropy.platformVersion',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        const data = await navigator.userAgentData.getHighEntropyValues(['platformVersion']);
        return data.platformVersion;
      },
      compare: (http, js) => {
        if (http === undefined) return null;
        const httpClean = http.replace(/"/g, '');
        return httpClean === (js || '');
      },
      async: true
    },
    {
      name: 'Full Version List',
      httpHeader: 'sec-ch-ua-full-version-list',
      jsApi: 'highEntropy.fullVersionList',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        const data = await navigator.userAgentData.getHighEntropyValues(['fullVersionList']);
        if (!data.fullVersionList) return null;
        return data.fullVersionList.map(b => `"${b.brand}";v="${b.version}"`).join(', ');
      },
      compare: (http, js) => {
        if (!http || !js) return null;
        const httpNorm = http.replace(/\s/g, '');
        const jsNorm = js.replace(/\s/g, '');
        return httpNorm === jsNorm;
      },
      async: true
    },
    {
      name: 'WoW64',
      httpHeader: 'sec-ch-ua-wow64',
      jsApi: 'highEntropy.wow64',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        const data = await navigator.userAgentData.getHighEntropyValues(['wow64']);
        return data.wow64;
      },
      compare: (http, js) => {
        if (http === undefined || js === undefined) return null;
        const httpBool = http === '?1';
        return httpBool === js;
      },
      async: true
    },
    {
      name: 'Form Factors',
      httpHeader: 'sec-ch-ua-form-factors',
      jsApi: 'highEntropy.formFactors',
      getJs: async () => {
        if (!navigator.userAgentData?.getHighEntropyValues) return null;
        try {
          const data = await navigator.userAgentData.getHighEntropyValues(['formFactors']);
          if (!data.formFactors) return null;
          return data.formFactors.map(f => `"${f}"`).join(', ');
        } catch (e) {
          return null;
        }
      },
      compare: (http, js) => {
        if (!http || !js) return null;
        const httpNorm = http.replace(/\s/g, '');
        const jsNorm = js.replace(/\s/g, '');
        return httpNorm === jsNorm;
      },
      async: true
    }
  ];

  // Fetch HTTP headers
  async function fetchHttpHeaders() {
    const services = [
      'https://httpbin.org/headers',
      'https://www.httpbin.org/headers',
    ];

    for (const url of services) {
      try {
        const response = await fetch(url, {
          method: 'GET',
          cache: 'no-store'
        });

        if (response.ok) {
          const data = await response.json();
          // httpbin returns headers in data.headers
          return data.headers || data;
        }
      } catch (e) {
        console.warn(`Failed to fetch from ${url}:`, e);
      }
    }

    // Fallback: —Å–æ–∑–¥–∞—ë–º echo endpoint —á–µ—Ä–µ–∑ worker (–µ—Å–ª–∏ httpbin –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
    throw new Error('Could not fetch HTTP headers from any service');
  }

  // Collect JS data
  async function collectJsData() {
    const data = {
      'navigator.userAgent': navigator.userAgent,
      'navigator.platform': navigator.platform,
      'navigator.vendor': navigator.vendor,
      'navigator.language': navigator.language,
      'navigator.languages': navigator.languages?.join(', '),
      'navigator.hardwareConcurrency': navigator.hardwareConcurrency,
      'navigator.deviceMemory': navigator.deviceMemory,
      'navigator.maxTouchPoints': navigator.maxTouchPoints,
    };

    // UserAgentData (if available)
    if (navigator.userAgentData) {
      data['userAgentData.mobile'] = navigator.userAgentData.mobile;
      data['userAgentData.platform'] = navigator.userAgentData.platform;
      data['userAgentData.brands'] = JSON.stringify(navigator.userAgentData.brands);
    }

    return data;
  }

  // Collect high entropy values
  async function collectHighEntropy() {
    if (!navigator.userAgentData?.getHighEntropyValues) {
      return { error: 'getHighEntropyValues not supported' };
    }

    try {
      const hints = [
        'architecture',
        'bitness',
        'brands',
        'fullVersionList',
        'model',
        'platform',
        'platformVersion',
        'wow64',
        'formFactors'
      ];

      const data = await navigator.userAgentData.getHighEntropyValues(hints);
      return data;
    } catch (e) {
      return { error: e.message };
    }
  }

  // Run comparison
  async function runComparison(httpHeaders, jsData, highEntropy) {
    const results = [];

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏ (lowercase keys)
    const headers = {};
    for (const [key, value] of Object.entries(httpHeaders)) {
      headers[key.toLowerCase()] = value;
    }

    for (const item of COMPARISON_MAP) {
      const httpValue = headers[item.httpHeader];
      let jsValue;

      if (item.async) {
        try {
          jsValue = await item.getJs();
        } catch (e) {
          jsValue = null;
        }
      } else {
        jsValue = item.getJs();
      }

      let status = 'unknown';
      let match = null;

      if (httpValue === undefined && jsValue === undefined) {
        status = 'both-missing';
      } else if (httpValue === undefined) {
        status = 'http-missing';
      } else if (jsValue === undefined || jsValue === null) {
        status = 'js-missing';
      } else {
        match = item.compare(httpValue, jsValue);
        status = match ? 'match' : 'mismatch';
      }

      results.push({
        name: item.name,
        httpHeader: item.httpHeader,
        jsApi: item.jsApi,
        httpValue: httpValue,
        jsValue: jsValue,
        status: status,
        match: match
      });
    }

    return results;
  }

  // Generate alerts
  function generateAlerts(comparison) {
    const alerts = [];

    // Check for critical mismatches
    const criticalParams = ['User-Agent', 'Platform', 'Mobile', 'Architecture', 'Bitness'];

    for (const item of comparison) {
      if (item.status === 'mismatch') {
        const isCritical = criticalParams.includes(item.name);
        alerts.push({
          type: isCritical ? 'error' : 'warning',
          title: `${item.name} Mismatch Detected`,
          desc: `HTTP: "${item.httpValue}" vs JS: "${item.jsValue}"`,
          critical: isCritical
        });
      }
    }

    // Check for Android-specific issues
    const platform = comparison.find(c => c.name === 'Platform');
    const arch = comparison.find(c => c.name === 'Architecture');
    const mobile = comparison.find(c => c.name === 'Mobile');

    if (platform?.jsValue === 'Android') {
      // Android should have empty architecture
      if (arch?.jsValue && arch.jsValue !== '') {
        alerts.push({
          type: 'error',
          title: 'Invalid Android Architecture',
          desc: `Architecture should be empty on Android, got: "${arch.jsValue}"`,
          critical: true
        });
      }

      // Android should be mobile
      if (mobile?.jsValue === false) {
        alerts.push({
          type: 'error',
          title: 'Invalid Mobile Flag for Android',
          desc: 'Mobile flag is false but platform is Android',
          critical: true
        });
      }
    }

    // Check for Desktop pretending to be Mobile
    if (platform?.jsValue === 'Linux' && mobile?.jsValue === true) {
      alerts.push({
        type: 'warning',
        title: 'Suspicious Configuration',
        desc: 'Platform is Linux but mobile flag is true',
        critical: false
      });
    }

    // No issues found
    if (alerts.length === 0) {
      alerts.push({
        type: 'success',
        title: 'All Checks Passed',
        desc: 'HTTP headers and JavaScript APIs are synchronized correctly',
        critical: false
      });
    }

    return alerts;
  }

  // Calculate score
  function calculateScore(comparison) {
    let matches = 0;
    let mismatches = 0;
    let warnings = 0;

    for (const item of comparison) {
      if (item.status === 'match') matches++;
      else if (item.status === 'mismatch') mismatches++;
      else warnings++;
    }

    return { matches, mismatches, warnings, total: comparison.length };
  }

  // Render functions
  function renderSummary(score) {
    const html = `
        <div class="summary-card ${score.mismatches === 0 ? 'success' : 'error'}">
          <div class="number" style="color: ${score.mismatches === 0 ? '#3fb950' : '#f85149'}">
            ${score.mismatches === 0 ? '‚úì' : score.mismatches}
          </div>
          <div class="label">Mismatches</div>
        </div>
        <div class="summary-card success">
          <div class="number" style="color: #3fb950">${score.matches}</div>
          <div class="label">Matches</div>
        </div>
        <div class="summary-card warning">
          <div class="number" style="color: #d29922">${score.warnings}</div>
          <div class="label">Unknown/Missing</div>
        </div>
        <div class="summary-card">
          <div class="number" style="color: #58a6ff">${score.total}</div>
          <div class="label">Total Checks</div>
        </div>
      `;
    document.getElementById('summary').innerHTML = html;
  }

  function renderAlerts(alerts) {
    const html = alerts.map(alert => `
        <div class="alert alert-${alert.type}">
          <span class="alert-icon">${alert.type === 'error' ? '‚ùå' : alert.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
          <div class="alert-content">
            <div class="alert-title">${alert.title}</div>
            <div class="alert-desc">${alert.desc}</div>
          </div>
        </div>
      `).join('');
    document.getElementById('alerts').innerHTML = html;
  }

  function renderComparison(comparison) {
    const html = comparison.map(item => {
      let statusClass = '';
      let statusIcon = '';

      switch (item.status) {
        case 'match':
          statusClass = 'match';
          statusIcon = '<span class="status-icon status-match">‚úì</span> Match';
          break;
        case 'mismatch':
          statusClass = 'mismatch';
          statusIcon = '<span class="status-icon status-mismatch">‚úó</span> Mismatch';
          break;
        default:
          statusClass = 'warning';
          statusIcon = '<span class="status-icon status-warning">?</span> ' + item.status;
      }

      return `
          <tr class="${statusClass}">
            <td><strong>${item.name}</strong><br><small style="color: #8b949e">${item.httpHeader}</small></td>
            <td class="value">${item.httpValue !== undefined ? escapeHtml(String(item.httpValue)) : '<span class="missing">not sent</span>'}</td>
            <td class="value">${item.jsValue !== undefined && item.jsValue !== null ? escapeHtml(String(item.jsValue)) : '<span class="missing">not available</span>'}</td>
            <td>${statusIcon}</td>
          </tr>
        `;
    }).join('');
    document.getElementById('comparison-body').innerHTML = html;
  }

  function renderHttpHeaders(headers) {
    const relevantHeaders = [
      'user-agent',
      'sec-ch-ua',
      'sec-ch-ua-mobile',
      'sec-ch-ua-platform',
      'sec-ch-ua-arch',
      'sec-ch-ua-bitness',
      'sec-ch-ua-model',
      'sec-ch-ua-platform-version',
      'sec-ch-ua-full-version-list',
      'sec-ch-ua-wow64',
      'sec-ch-ua-form-factors',
      'accept-language',
      'accept-encoding',
      'sec-fetch-dest',
      'sec-fetch-mode',
      'sec-fetch-site'
    ];

    const html = Object.entries(headers)
            .sort((a, b) => {
              const aIdx = relevantHeaders.indexOf(a[0].toLowerCase());
              const bIdx = relevantHeaders.indexOf(b[0].toLowerCase());
              if (aIdx === -1 && bIdx === -1) return a[0].localeCompare(b[0]);
              if (aIdx === -1) return 1;
              if (bIdx === -1) return -1;
              return aIdx - bIdx;
            })
            .map(([key, value]) => `
          <tr>
            <td>${escapeHtml(key)}</td>
            <td class="value">${escapeHtml(String(value))}</td>
          </tr>
        `).join('');
    document.getElementById('http-body').innerHTML = html;
  }

  function renderJsData(data) {
    const html = Object.entries(data)
            .map(([key, value]) => `
          <tr>
            <td>${escapeHtml(key)}</td>
            <td class="value">${value !== undefined ? escapeHtml(String(value)) : '<span class="missing">undefined</span>'}</td>
          </tr>
        `).join('');
    document.getElementById('js-body').innerHTML = html;
  }

  function renderHighEntropy(data) {
    if (data.error) {
      document.getElementById('high-entropy-body').innerHTML = `
          <tr><td colspan="2" class="missing">${escapeHtml(data.error)}</td></tr>
        `;
      return;
    }

    const html = Object.entries(data)
            .map(([key, value]) => {
              let displayValue = value;
              if (Array.isArray(value)) {
                displayValue = JSON.stringify(value);
              } else if (typeof value === 'object' && value !== null) {
                displayValue = JSON.stringify(value);
              }
              return `
            <tr>
              <td>${escapeHtml(key)}</td>
              <td class="value">${displayValue !== undefined ? escapeHtml(String(displayValue)) : '<span class="missing">undefined</span>'}</td>
            </tr>
          `;
            }).join('');
    document.getElementById('high-entropy-body').innerHTML = html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Main test function
  async function runTest() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';

    try {
      // Collect all data
      const [httpHeaders, jsData, highEntropy] = await Promise.all([
        fetchHttpHeaders(),
        collectJsData(),
        collectHighEntropy()
      ]);

      // Run comparison
      const comparison = await runComparison(httpHeaders, jsData, highEntropy);

      // Generate alerts
      const alerts = generateAlerts(comparison);

      // Calculate score
      const score = calculateScore(comparison);

      // Store results
      testResults = {
        timestamp: new Date().toISOString(),
        httpHeaders,
        jsData,
        highEntropy,
        comparison,
        alerts,
        score
      };

      // Render
      renderSummary(score);
      renderAlerts(alerts);
      renderComparison(comparison);
      renderHttpHeaders(httpHeaders);
      renderJsData(jsData);
      renderHighEntropy(highEntropy);
      document.getElementById('raw-json').textContent = JSON.stringify(testResults, null, 2);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('results').style.display = 'block';

    } catch (error) {
      document.getElementById('loading').innerHTML = `
          <p style="color: #f85149;">‚ùå Error: ${escapeHtml(error.message)}</p>
          <p style="color: #8b949e;">Try refreshing the page or check your network connection.</p>
          <button onclick="runTest()">Retry</button>
        `;
    }
  }

  // Copy results
  function copyResults() {
    navigator.clipboard.writeText(JSON.stringify(testResults, null, 2))
            .then(() => alert('Results copied to clipboard!'))
            .catch(err => alert('Failed to copy: ' + err));
  }

  // Auto-run on load
  window.addEventListener('DOMContentLoaded', runTest);
</script>
</body>
</html>